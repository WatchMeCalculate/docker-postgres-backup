# pg-backup-restore-gbucket

Will backup or restore or both on a cron job or single use. It upload or download from specified google bucket

## Set Up Needed

1. A Google project setup with a bucket ready to go
2. A Google service account with the necessary permissions to upload/download from the storage bucket. You will also need to generate a key.


## Environment variables


- `POSTGRES_DATABASE`: Database name
- `POSTGRES_PASSWORD`: Database password
- `POSTGRES_USER`: Database user
- `POSTGRES_HOST`: Database hostname, if inside a docker env it can be the database's container name
- `GCLOUD_PRIVATE_KEY_ID_B64`: This is generated by running `cat ./access-key.json|base64` and storing it
- `GCLOUD_ACCOUNT`: This is the full "email" of the service account that is created
- `GCLOUD_PROJECT`: Project name that the google storage bucket resides in
- `GS_BUCKET`: google storage bucket URI
- `SCHEDULE`: A valid cron tab string


## How To Run

```
docker run -e GCLOUD_PRIVATE_KEY_ID_B64=<Generated key> -e GCLOUD_ACCOUNT=<service-account>@<project-id>.iam.gserviceaccount.com -e GCLOUD_PROJECT=<gcloud_project> -e GS_BUCKET=<bucket_name> -e POSTGRES_DATABASE=db -e POSTGRES_HOST=db -e POSTGRES_USER=postgres -e SCHEDULE="* * * * *" -e POSTGRES_PASSWORD=<password>  watchmecalculate/pg-backup-restore-gbucket

```

```
services:
  db:
    image: postgres:13.2
    environment:
      - POSTGRES_DATABASE=test
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
  db-backup:
    image: watchmecalculate/pg-backup-restore-gbucket
    environment:
      - POSTGRES_DATABASE=test
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_HOST=db
      - GCLOUD_PRIVATE_KEY_ID_B64=<Generated key>
      - GCLOUD_ACCOUNT=<service-account>@<project-id>.iam.gserviceaccount.com
      - GCLOUD_PROJECT=<gcloud_project>
      - GS_BUCKET=<bucket_name>
      - SCHEDULE="@daily"
```

## Command options

There are four different CMD strings that can be passed in:

- `restore-and-cron`: Will start off by restoring the databse by retrieving latest dump from the storage bucket. Then will resume scheduled backups
- `backup-and-cron`: Will start off by backing up the databse. Then will resume scheduled backups
- `backup`: Will back up the databse, then exits.
- `restore`:  Will restore the database by retrieving latest dump from the storage bucket, then exits.

